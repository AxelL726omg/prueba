<!DOCTYPE html>
<html>
<head>
  <title>MQTT Web Client</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js"></script>
</head>
<body>
  <h2>Mensajes recibidos en juan23/chat:</h2>
  <div id="messages"></div>

  <script>
    // Configuraci√≥n del broker MQTT de Flespi
    const brokerHost = "mqtt.flespi.io";
    const brokerPort = 443;
    const brokerPath = "/mqtt"; // Ruta obligatoria para WebSockets

    const topic = "juan23/chat";

    // ‚ö†Ô∏è Reemplazar con tu token real desde flespi.io
    const flespiToken = "FlespiToken feRmBrbgP4G0GJU9sbhFh8OKRiQuIf4ZnIi8N3ORKh2lEScKK50A6Cx4hISyrEEV";

    // ID √∫nico para el cliente
    const clientID = "webclient_" + Math.floor(Math.random() * 10000);

    // Crear el cliente MQTT
    const client = new Paho.MQTT.Client(brokerHost, brokerPort, brokerPath, clientID);

    // Configurar el callback para p√©rdida de conexi√≥n
    client.onConnectionLost = function(responseObject) {
      if (responseObject.errorCode !== 0) {
        console.warn("‚ö†Ô∏è Conexi√≥n perdida:", responseObject.errorMessage);
      }
    };

    // Configurar el callback para recepci√≥n de mensajes
    client.onMessageArrived = function(message) {
      console.log("üì© Mensaje recibido:", message.payloadString);
      const msgDiv = document.getElementById("messages");
      msgDiv.innerHTML += "<p>" + message.payloadString + "</p>";
    };

    // Conectar al broker con opciones correctas
    client.connect({
      useSSL: true,
      userName: flespiToken,  // El token se pasa como nombre de usuario
      password: "",           // Obligatorio aunque sea vac√≠o
      onSuccess: onConnect,
      onFailure: function(err) {
        console.error("‚ùå Error al conectar:", err.errorMessage);
      }
    });

    // Cuando se conecta exitosamente
    function onConnect() {
      console.log("‚úÖ Conectado al broker Flespi");
      client.subscribe(topic);
    }
  </script>
</body>
</html>
